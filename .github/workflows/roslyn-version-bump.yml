name: Roslyn PR Finder

on:
  workflow_dispatch:

jobs:
  pr-finder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup .NET (9 & 8)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: |
            9.0.x
            8.0.x

      - name: Install roslyn-tools (global prerelease)
        id: install
        run: |
          set -euo pipefail
          FEED="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json"
          echo "Installing roslyn-tools prerelease from $FEED"
          dotnet tool install -g Microsoft.RoslynTools --prerelease --add-source "$FEED"
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"
          roslyn-tools --version

      - name: Authenticate roslyn-tools
        env:
          # Provide the same token under multiple var names to satisfy tool expectations
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ROSLYNTOOLS_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ROSLYN_TOOLS_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Attempting roslyn-tools authenticate (non-fatal if it fails)."
          if roslyn-tools authenticate --help 2>/dev/null | grep -qi github; then
            # Try common flag patterns (ignore failures)
            roslyn-tools authenticate --github-token "$GITHUB_TOKEN" --ci 2>&1 || true
            roslyn-tools authenticate --github "$GITHUB_TOKEN" 2>&1 || true
          else
            echo "authenticate command help did not mention github; proceeding anyway." || true
          fi
          # Show any settings produced
          if [ -d "$HOME/.roslyn-tools" ]; then
            echo "Contents of ~/.roslyn-tools:"; ls -R "$HOME/.roslyn-tools" || true
          else
            echo "No ~/.roslyn-tools directory created." || true
          fi

      - name: Determine commit range
        id: range
        run: |
          set -euo pipefail
          mkdir -p .github
          git clone --depth 2 https://github.com/dotnet/roslyn.git roslyn-temp
          pushd roslyn-temp
          END=$(git rev-parse HEAD)
          if [ -f ../.github/roslyn-last-sha.txt ]; then
            START=$(cat ../.github/roslyn-last-sha.txt)
            echo "Using saved START SHA: $START"
          else
            # First run: use previous commit in history
            START=$(git rev-parse HEAD~1 || echo $END)
            echo "No saved SHA; using previous commit: $START"
          fi
          popd
          echo "start_sha=$START" >> $GITHUB_OUTPUT
          echo "end_sha=$END" >> $GITHUB_OUTPUT

      - name: Run pr-finder
        env:
          START: ${{ steps.range.outputs.start_sha }}
          END: ${{ steps.range.outputs.end_sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ROSLYNTOOLS_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ROSLYN_TOOLS_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Finding PRs between $START and $END"
          pushd roslyn-temp
          roslyn-tools pr-finder -s "$START" -e "$END" --label changelog-worthy --format changelog > ../pr-changelog.txt
          popd
          echo "--- PR Changelog (first 100 lines) ---"
          head -n 100 pr-changelog.txt || true

      - name: Save end SHA for next run
        run: |
          echo "${{ steps.range.outputs.end_sha }}" > .github/roslyn-last-sha.txt
          echo "Saved latest SHA: $(cat .github/roslyn-last-sha.txt)"

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-changelog
          path: pr-changelog.txt