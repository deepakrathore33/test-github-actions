name: Roslyn Version Bump

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Install tools
        shell: bash
        run: |
          # Install roslyn-tools
          FEED="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json"
          dotnet tool install -g Microsoft.RoslynTools --prerelease --add-source "$FEED"
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"
          
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

      - name: Get current Roslyn SHA from package
        id: current
        shell: bash
        run: |
          set -euo pipefail
          
          # Read current version from package.json
          CURRENT_VERSION=$(jq -r '.defaults.roslyn // empty' package.json)
          
          echo "Current Roslyn version: $CURRENT_VERSION"
          
          # Download the NuGet package and extract commit SHA from .nuspec file
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # The package name used in vscode-csharp
          PACKAGE_NAME="microsoft.codeanalysis.common"
          
          # Download from dotnet-tools feed (where Roslyn packages are published)
          echo "Downloading from dotnet-tools feed..."
          DOTNET_TOOLS_FEED="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-tools/nuget/v3/flat2"
          PACKAGE_URL="$DOTNET_TOOLS_FEED/$PACKAGE_NAME/$CURRENT_VERSION/$PACKAGE_NAME.$CURRENT_VERSION.nupkg"
          
          curl -f -L -o package.nupkg "$PACKAGE_URL"
          echo "Package downloaded successfully"
          
          # Extract the package
          unzip -q package.nupkg
          
          # Find the .nuspec file
          NUSPEC_FILE=$(find . -name "*.nuspec" -type f | head -n1)
          echo "Found nuspec file: $NUSPEC_FILE"
          
          # Extract commit SHA from .nuspec file
          # Looking for: repository type="git" url="..." commit="SHA"
          START_SHA=$(grep -oP 'repository[^>]*commit="\K[a-f0-9]{40}' "$NUSPEC_FILE" | head -n1)
          
          cd - >/dev/null
          rm -rf "$TEMP_DIR"
          
          echo "start=$START_SHA" >> $GITHUB_OUTPUT
          echo "Current Roslyn SHA from nuspec: $START_SHA"

      - name: Get latest Roslyn build from Azure DevOps
        id: latest
        shell: bash
        run: |
          set -euo pipefail
          
          echo "Getting latest Roslyn build from Azure DevOps..."
          
          # Use Azure DevOps PAT if available
          if [ -n "${{ secrets.AZURE_DEVOPS_PAT }}" ]; then
            echo "Using Azure DevOps PAT for authentication"
            
            # Query Azure DevOps for the latest successful build from internal project
            AZDO_ORG="https://dev.azure.com/dnceng"
            PROJECT="internal"
            PIPELINE_ID="327"  # dotnet-roslyn-official pipeline ID
            
            # Create authorization header
            AUTH_HEADER="Authorization: Basic $(echo -n ':${{ secrets.AZURE_DEVOPS_PAT }}' | base64)"
            
            # Get the latest successful build from main branch
            BUILD_URL="$AZDO_ORG/$PROJECT/_apis/build/builds?definitions=$PIPELINE_ID&branchName=refs/heads/main&statusFilter=completed&resultFilter=succeeded&\$top=1&api-version=7.0"
            
            echo "Fetching latest build info..."
            BUILD_INFO=$(curl -s -H "Accept: application/json" -H "$AUTH_HEADER" "$BUILD_URL")
            
            # Check if response is valid JSON
            if ! echo "$BUILD_INFO" | jq empty 2>/dev/null; then
              echo "Error: Invalid response from Azure DevOps API"
              exit 1
            fi
            
            # Extract build information
            BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.value[0].id // empty')
            END_SHA=$(echo "$BUILD_INFO" | jq -r '.value[0].sourceVersion // empty')
            BUILD_NUMBER=$(echo "$BUILD_INFO" | jq -r '.value[0].buildNumber // empty')
            
            if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
              echo "Error: Could not get build ID"
              exit 1
            fi
            
            echo "Latest build: $BUILD_NUMBER (ID: $BUILD_ID)"
            echo "Commit SHA: $END_SHA"
            
            # Download AssetManifests artifact
            ARTIFACT_URL="$AZDO_ORG/$PROJECT/_apis/build/builds/$BUILD_ID/artifacts?artifactName=AssetManifests&api-version=7.0"
            
            echo "Getting AssetManifests artifact info..."
            ARTIFACT_INFO=$(curl -s -H "Accept: application/json" -H "$AUTH_HEADER" "$ARTIFACT_URL")
            DOWNLOAD_URL=$(echo "$ARTIFACT_INFO" | jq -r '.resource.downloadUrl // empty')
            
            if [ -n "$DOWNLOAD_URL" ] && [ "$DOWNLOAD_URL" != "null" ]; then
              # Download and extract AssetManifests
              TEMP_DIR=$(mktemp -d)
              cd "$TEMP_DIR"
              
              echo "Downloading AssetManifests..."
              curl -s -L -H "$AUTH_HEADER" -o assetmanifests.zip "$DOWNLOAD_URL"
              
              # Extract the zip file
              unzip -q assetmanifests.zip || unzip -q -j assetmanifests.zip
              
              # Find and parse OfficialBuild.xml
              XML_FILE=$(find . -name "OfficialBuild.xml" | head -n1)
              
              if [ -n "$XML_FILE" ]; then
                echo "Found OfficialBuild.xml, extracting version..."
                
                # Extract version from the XML
                VERSION=$(grep -oP 'Id="Microsoft\.CodeAnalysis"[^>]*Version="\K[^"]+' "$XML_FILE" | head -n1)
                
                if [ -z "$VERSION" ]; then
                  VERSION=$(grep -oP 'Id="Microsoft\.CodeAnalysis\.Common"[^>]*Version="\K[^"]+' "$XML_FILE" | head -n1)
                fi
                
                if [ -n "$VERSION" ]; then
                  echo "Extracted version from AssetManifest: $VERSION"
                  
                  # Also verify commit from Build element
                  COMMIT_FROM_XML=$(grep -oP '<Build[^>]*Commit="\K[^"]+' "$XML_FILE" | head -n1)
                  if [ -n "$COMMIT_FROM_XML" ]; then
                    echo "Commit from AssetManifest: $COMMIT_FROM_XML"
                    END_SHA="$COMMIT_FROM_XML"
                  fi
                fi
              fi
              
              cd - >/dev/null
              rm -rf "$TEMP_DIR"
            fi
            
            # If we couldn't get version from AssetManifests, construct it
            if [ -z "$VERSION" ]; then
              VERSION="5.0.0-ci.$BUILD_NUMBER"
              echo "Using constructed version: $VERSION"
            fi
            
            AZDO_ORG="https://dev.azure.com/dnceng"
            PROJECT="internal"
            
          else
            echo "No Azure DevOps PAT configured, falling back to NuGet feed approach..."
            
            # Query Azure DevOps for the latest successful build
            AZDO_ORG="https://dev.azure.com/dnceng"
            PROJECT="public"  # Try public project first
            PIPELINE_ID="15"  # dotnet-roslyn pipeline ID in public project
            
            # Get the latest successful build from main branch
            BUILD_URL="$AZDO_ORG/$PROJECT/_apis/build/builds?definitions=$PIPELINE_ID&branchName=refs/heads/main&statusFilter=completed&resultFilter=succeeded&\$top=1&api-version=7.0"
            
            echo "Fetching latest build info from URL: $BUILD_URL"
            
            # Fetch with verbose output to see what's happening
            BUILD_INFO=$(curl -s -H "Accept: application/json" "$BUILD_URL" 2>&1)
            
            # Check if we got HTML instead of JSON (common error response)
            if echo "$BUILD_INFO" | grep -q "<!DOCTYPE"; then
              echo "Error: Received HTML response instead of JSON. The API endpoint might be incorrect or require authentication."
              echo "Response preview: ${BUILD_INFO:0:500}"
              
              # Fallback to querying NuGet feed for latest version
              echo "Falling back to NuGet feed for latest version..."
              
              PACKAGE_NAME="microsoft.codeanalysis.common"
              PACKAGE_INDEX="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-tools/nuget/v3/flat2/$PACKAGE_NAME/index.json"
              
              echo "Fetching package index from: $PACKAGE_INDEX"
              VERSIONS=$(curl -s "$PACKAGE_INDEX" | jq -r '.versions[]' 2>/dev/null || echo "")
              
              if [ -z "$VERSIONS" ]; then
                # Try dotnet8 feed as fallback
                PACKAGE_INDEX="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet8/nuget/v3/flat2/$PACKAGE_NAME/index.json"
                echo "Trying dotnet8 feed: $PACKAGE_INDEX"
                VERSIONS=$(curl -s "$PACKAGE_INDEX" | jq -r '.versions[]' 2>/dev/null || echo "")
              fi
              
              # Get the latest prerelease version
              VERSION=$(echo "$VERSIONS" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+-' | tail -n1)
              
              if [ -z "$VERSION" ]; then
                echo "Error: Could not find any Roslyn versions in feed"
                exit 1
              fi
              
              echo "Latest version from NuGet feed: $VERSION"
              
              # Download package to get commit SHA
              TEMP_DIR=$(mktemp -d)
              cd "$TEMP_DIR"
              
              DOTNET_TOOLS_FEED="https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-tools/nuget/v3/flat2"
              PACKAGE_URL="$DOTNET_TOOLS_FEED/$PACKAGE_NAME/$VERSION/$PACKAGE_NAME.$VERSION.nupkg"
              
              echo "Downloading package from: $PACKAGE_URL"
              curl -f -L -o package.nupkg "$PACKAGE_URL"
              unzip -q package.nupkg
              
              NUSPEC_FILE=$(find . -name "*.nuspec" -type f | head -n1)
              END_SHA=$(grep -oP 'repository[^>]*commit="\K[a-f0-9]{40}' "$NUSPEC_FILE" | head -n1)
              
              cd - >/dev/null
              rm -rf "$TEMP_DIR"
              
              # Set default values for build info
              BUILD_ID="nuget"
              BUILD_NUMBER="$VERSION"
              AZDO_ORG="https://github.com/dotnet/roslyn"
              PROJECT="commit"
            else
              # Try to parse as JSON
              echo "Parsing API response as JSON..."
              
              # Save response for debugging
              echo "$BUILD_INFO" > /tmp/build_info.json
              echo "Response saved to /tmp/build_info.json"
              
              # Check if response is valid JSON
              if ! echo "$BUILD_INFO" | jq empty 2>/dev/null; then
                echo "Error: Invalid JSON response from Azure DevOps API"
                echo "Response preview: ${BUILD_INFO:0:500}"
                exit 1
              fi
              
              # Check if we got any builds
              BUILD_COUNT=$(echo "$BUILD_INFO" | jq '.count // 0')
              echo "Number of builds returned: $BUILD_COUNT"
              
              if [ "$BUILD_COUNT" -eq 0 ]; then
                echo "No builds found. Response:"
                echo "$BUILD_INFO" | jq '.'
                exit 1
              fi
              
              # Extract build ID and commit SHA
              BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.value[0].id // empty')
              END_SHA=$(echo "$BUILD_INFO" | jq -r '.value[0].sourceVersion // empty')
              BUILD_NUMBER=$(echo "$BUILD_INFO" | jq -r '.value[0].buildNumber // empty')
              
              if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
                echo "Error: Could not get build ID from Azure DevOps"
                echo "Build info:"
                echo "$BUILD_INFO" | jq '.value[0]'
                exit 1
              fi
              
              echo "Latest build: $BUILD_NUMBER (ID: $BUILD_ID)"
              echo "Commit SHA: $END_SHA"
              
              # For now, use build number as version since AssetManifests download requires auth
              VERSION="5.0.0-ci.$BUILD_NUMBER"
              echo "Using constructed version: $VERSION"
            fi
          fi
          
          echo "end=$END_SHA" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "build_url=$AZDO_ORG/$PROJECT/_build/results?buildId=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          
          echo "Final values:"
          echo "  Roslyn commit: $END_SHA"
          echo "  Roslyn version: $VERSION"
          echo "  Build ID: $BUILD_ID"
          
          if [ "${{ steps.current.outputs.start }}" = "$END_SHA" ]; then
            echo "no_change=true" >> $GITHUB_OUTPUT
            echo "No new commits to process"
          fi

      - name: Clone roslyn for PR finder
        if: steps.latest.outputs.no_change != 'true'
        shell: bash
        run: |
          git clone --no-tags --filter=blob:none --depth=500 https://github.com/dotnet/roslyn.git roslyn

      - name: Auth settings
        if: steps.latest.outputs.no_change != 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.roslyn-tools"
          
          JSON=$(printf '{"GitHubToken":"%s","DevDivAzureDevOpsToken":"","DncEngAzureDevOpsToken":""}' "${{ secrets.GITHUB_TOKEN }}")
          printf '%s' "$JSON" | base64 | tr -d '\n' > "$HOME/.roslyn-tools/settings"

      - name: Generate PR list
        id: prs
        if: steps.latest.outputs.no_change != 'true'
        shell: bash
        run: |
          set -euo pipefail
          pushd roslyn >/dev/null
          
          # Run pr-finder with VSCode label only
          if OUTPUT=$(roslyn-tools pr-finder \
            -s "${{ steps.current.outputs.start }}" \
            -e "${{ steps.latest.outputs.end }}" \
            --format changelog \
            --label VSCode 2>/dev/null); then
            if [ -z "$OUTPUT" ]; then
              echo "(no PRs with required labels)" > ../pr-changelog.txt
            else
              printf "%s\n" "$OUTPUT" > ../pr-changelog.txt
            fi
          else
            echo "(pr-finder failed)" > ../pr-changelog.txt
          fi
          
          popd >/dev/null
          cat pr-changelog.txt
          
          if grep -qE '^\((no PRs|pr-finder failed)\)' pr-changelog.txt; then 
            echo "empty=true" >> $GITHUB_OUTPUT
          fi

      - name: Update CHANGELOG and package.json
        id: update
        if: steps.latest.outputs.no_change != 'true'
        uses: actions/github-script@v7
        env:
          ROSLYN_VER: ${{ steps.latest.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { readFile, writeFile } = require('fs/promises');
            
            const CHANGELOG = 'CHANGELOG.md';
            const PR_FILE = 'pr-changelog.txt';
            const roslynVer = process.env.ROSLYN_VER || 'unknown';
            
            core.info(`Updating with Roslyn version: ${roslynVer}`);
            
            // Update package.json
            try {
              const pkg = JSON.parse(await readFile('package.json', 'utf8'));
              if (!pkg.defaults) pkg.defaults = {};
              
              const oldVersion = pkg.defaults.roslyn;
              if (oldVersion !== roslynVer) {
                core.info(`Updating package.json: ${oldVersion} -> ${roslynVer}`);
                pkg.defaults.roslyn = roslynVer;
                await writeFile('package.json', JSON.stringify(pkg, null, 2) + '\n');
              }
            } catch (err) {
              core.setFailed(`Failed to update package.json: ${err.message}`);
              return;
            }
            
            // Load PR list
            let prLines = [];
            try {
              const prContent = await readFile(PR_FILE, 'utf8');
              prLines = prContent
                .split(/\r?\n/)
                .filter(l => l.trim().length && !l.includes('[View Complete Diff'))
                .map(l => l.startsWith('*') ? `  ${l}` : `  * ${l}`);
            } catch (err) {
              core.warning(`Could not read ${PR_FILE}: ${err.message}`);
            }
            
            // Update CHANGELOG
            const content = await readFile(CHANGELOG, 'utf8');
            const lines = content.split(/\r?\n/);
            
            // Find first section and existing bump line
            let bumpLineIndex = -1;
            let firstHeaderIndex = lines.findIndex(l => /^# /.test(l));
            let nextHeaderIndex = lines.findIndex((l, i) => i > firstHeaderIndex && /^# /.test(l));
            let sectionEnd = nextHeaderIndex > 0 ? nextHeaderIndex : lines.length;
            
            for (let i = firstHeaderIndex + 1; i < sectionEnd; i++) {
              if (/^\* Bump Roslyn to .* \(PR:/.test(lines[i])) {
                bumpLineIndex = i;
                break;
              }
            }
            
            if (bumpLineIndex === -1) {
              core.setFailed('Could not find existing Roslyn bump line');
              return;
            }
            
            // Update bump line
            lines[bumpLineIndex] = `* Bump Roslyn to ${roslynVer} (PR: [#TBD](TBD))`;
            
            // Insert PR lines
            let insertPoint = bumpLineIndex + 1;
            while (insertPoint < lines.length && lines[insertPoint].startsWith('  *')) {
              insertPoint++;
            }
            
            if (prLines.length > 0) {
              lines.splice(insertPoint, 0, ...prLines);
            }
            
            await writeFile(CHANGELOG, lines.join('\n'));
            core.info('Successfully updated CHANGELOG.md');

      - name: Create PR
        if: steps.latest.outputs.no_change != 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: roslyn-bump/${{ steps.latest.outputs.end }}
          commit-message: "Bump Roslyn to ${{ steps.latest.outputs.version }}"
          title: "Bump Roslyn to ${{ steps.latest.outputs.version }}"
          add-paths: |
            CHANGELOG.md
            package.json
          body: |
            Automated Roslyn version bump.
            
            **Version:** `${{ steps.latest.outputs.version }}`
            **Commit Range:** `${{ steps.current.outputs.start }}....${{ steps.latest.outputs.end }}`
            **Azure DevOps Build:** [${{ steps.latest.outputs.build_id }}](${{ steps.latest.outputs.build_url }})
            
            See CHANGELOG.md for included PRs.

      - name: Backfill PR link in CHANGELOG
        if: steps.cpr.outputs.pull-request-number && steps.latest.outputs.no_change != 'true'
        shell: bash
        run: |
          set -euo pipefail
          
          PR_URL="${{ steps.cpr.outputs.pull-request-url }}"
          PR_NUM="${{ steps.cpr.outputs.pull-request-number }}"
          BRANCH="roslyn-bump/${{ steps.latest.outputs.end }}"
          
          git fetch origin "$BRANCH" --depth=1
          git checkout "$BRANCH"
          
          # Replace TBD placeholders with actual PR number and URL
          sed -i "s|#TBD|#$PR_NUM|" CHANGELOG.md
          sed -i "s|(TBD)|($PR_URL)|" CHANGELOG.md
          
          if git diff --quiet; then
            echo "No placeholder replacement occurred."
            exit 0
          fi
          
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "Backfill PR link #$PR_NUM"
          git push origin "$BRANCH"